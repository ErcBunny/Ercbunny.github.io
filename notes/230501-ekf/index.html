<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Step by step derivation of the Kalman Filter, and introduce the EKF.'>
<title>Extended Kalman Filter</title>

<link rel='canonical' href='https://ercbunny.github.io/notes/230501-ekf/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='Extended Kalman Filter'>
<meta property='og:description' content='Step by step derivation of the Kalman Filter, and introduce the EKF.'>
<meta property='og:url' content='https://ercbunny.github.io/notes/230501-ekf/'>
<meta property='og:site_name' content='Ryan&#39;s Page'>
<meta property='og:type' content='article'><meta property='article:section' content='Notes' /><meta property='article:tag' content='GRE' /><meta property='article:published_time' content='2023-05-01T21:40:00&#43;08:00'/><meta property='article:modified_time' content='2023-05-01T21:40:00&#43;08:00'/><meta property='og:image' content='https://ercbunny.github.io/notes/230501-ekf/cover.jpg' />
<meta name="twitter:site" content="@yueqianliu1">
    <meta name="twitter:creator" content="@yueqianliu1"><meta name="twitter:title" content="Extended Kalman Filter">
<meta name="twitter:description" content="Step by step derivation of the Kalman Filter, and introduce the EKF."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://ercbunny.github.io/notes/230501-ekf/cover.jpg' />
    <link rel="shortcut icon" href="/img/user.svg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu047d7df235c50937c4e2e6b6880cc61b_117975_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Ryan&#39;s Page</a></h1>
            <h2 class="site-description">Yueqian Liu | 刘越千</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/ErcBunny'
                        target="_blank"
                        title="1-GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/ryan-yql/'
                        target="_blank"
                        title="2-linkedIn"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0,0,256,256" width="50px" height="50px" fill-rule="nonzero"><g fill-opacity="1" fill="#cdcdcd" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode: normal"><g transform="scale(5.12,5.12)"><path d="M41,4h-32c-2.76,0 -5,2.24 -5,5v32c0,2.76 2.24,5 5,5h32c2.76,0 5,-2.24 5,-5v-32c0,-2.76 -2.24,-5 -5,-5zM17,20v19h-6v-19zM11,14.47c0,-1.4 1.2,-2.47 3,-2.47c1.8,0 2.93,1.07 3,2.47c0,1.4 -1.12,2.53 -3,2.53c-1.8,0 -3,-1.13 -3,-2.53zM39,39h-6c0,0 0,-9.26 0,-10c0,-2 -1,-4 -3.5,-4.04h-0.08c-2.42,0 -3.42,2.06 -3.42,4.04c0,0.91 0,10 0,10h-6v-19h6v2.56c0,0 1.93,-2.56 5.81,-2.56c3.97,0 7.19,2.73 7.19,8.26z"></path></g></g></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://space.bilibili.com/16031917'
                        target="_blank"
                        title="3-BiliBili"
                        rel="me"
                    >
                        
                        
                            <svg t="1638771673560" class="icon" viewBox="0 0 2299 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2977" width="200" height="200"><path d="M1775.840814 322.588002c6.0164 1.002733 53.144869-9.525967 55.150336-6.016401 3.0082 4.5123 24.065601 155.92504 18.550567 156.927774s-44.621635 10.027334-44.621635 10.027334c-3.0082-20.556034-28.577901-147.903173-29.079268-160.938707m75.205003-14.539634l20.556034 162.944174c10.5287-0.501367 53.144869-3.509567 57.155803-4.010934-6.0164-61.668103-16.545101-158.933241-16.545101-158.93324-20.054668-4.010934-41.112069-4.010934-61.166736 0m-40.610702 226.116376s92.752838-23.564234 126.344406-12.0328c17.046467 61.668103 48.131202 407.611118 51.139402 421.649386-21.057401 2.506833-90.246004 8.523234-95.761037 10.027333-4.5123-26.071068-81.72277-403.098818-81.722771-419.643919m343.436183-207.565809c5.515034 1.5041 54.648969-5.013667 55.150335-1.5041 1.002733 12.032801 6.0164 157.42914 0.501367 157.930507s-44.621635 4.010934-44.621635 4.010934c-1.002733-20.054668-12.032801-146.90044-11.030067-160.437341m75.70637-4.010933l4.010933 160.938707c10.5287 0 52.643502 2.506833 57.155803 2.005467-1.002733-61.668103 0-158.933241 0-158.933241-20.054668-3.509567-40.610702-5.013667-61.166736-4.010933m-64.676303 216.089043s94.758304-12.534167 126.845772 2.506833c7.019134 72.196803 6.0164 408.613852 7.019134 422.652119-21.558768 0-90.246004 1.002733-95.761038 2.005467-1.002733-26.071068-39.607968-410.619319-38.103868-427.164419m-220.099977-413.627519c54.648969 278.759879 96.262404 755.058234 97.766504 785.641602 0 0 43.117535 1.002733 91.750105 4.010934C2105.740095 614.383415 2070.644427 134.575493 2071.145794 119.033126c-12.032801-13.536901-126.344406 6.0164-126.344406 6.0164m-120.328005 659.297196c-10.5287-78.213204-290.291313-166.955108-447.720454-138.377206 0 0-19.553301-172.470141-27.073801-339.425248-6.517767-143.390873-1.002733-282.770813 0.501366-305.833681-10.5287-7.5205-123.837572 46.627102-185.004308 69.188603 0 0 73.199537 309.844614 126.344406 952.59671 0 0 84.730971 9.0246 230.12731-19.051934s317.365114-115.815705 302.825481-219.097244m-341.932083 140.88404l-24.566967-176.982441c6.0164-3.0082 156.927774 53.144869 172.971507 63.172203-2.506833 11.030067-148.40454 113.810238-148.40454 113.810238M610.664628 322.588002c6.0164 1.002733 53.144869-9.525967 55.150335-6.016401 3.0082 4.5123 24.065601 155.92504 18.550568 156.927774s-44.621635 10.027334-44.621635 10.027334c-3.0082-20.556034-28.577901-147.903173-29.079268-160.938707m75.205003-14.539634l20.556034 162.944174c10.5287-0.501367 53.144869-3.509567 57.155803-4.010934-6.517767-61.668103-16.545101-158.933241-16.545101-158.93324-20.054668-4.010934-41.112069-4.010934-61.166736 0m-40.610702 226.116376s92.752838-23.564234 126.344406-12.0328c17.046467 61.668103 48.131202 407.611118 51.139402 421.649386-21.057401 2.506833-90.246004 8.523234-95.761037 10.027333-4.5123-26.071068-81.72277-403.098818-81.722771-419.643919m343.436182-207.565809c5.515034 1.5041 54.648969-5.013667 55.150336-1.5041 1.002733 12.032801 6.0164 157.42914 0.501367 157.930507s-44.621635 4.010934-44.621635 4.010934c-1.002733-20.054668-11.531434-146.90044-11.030068-160.437341m75.706371-4.010933l4.010933 160.938707c10.5287 0 52.643502 2.506833 57.155803 2.005467-1.002733-61.668103 0-158.933241 0-158.933241-20.054668-3.509567-40.610702-4.5123-61.166736-4.010933m-64.676303 216.089043s94.758304-12.534167 126.845772 2.506833c7.019134 72.196803 6.0164 408.613852 7.019134 422.652119-21.558768 0-90.246004 1.002733-95.761038 2.005467-0.501367-26.071068-39.607968-410.619319-38.103868-427.164419m-220.099977-413.627519c54.648969 278.759879 96.262404 755.058234 97.766504 785.641602 0 0 43.117535 1.002733 91.750105 4.010934-28.577901-300.318647-63.67357-780.126569-63.172203-796.170303-12.032801-13.035534-126.344406 6.517767-126.344406 6.517767m-120.328005 659.297196c-10.5287-78.213204-290.291313-166.955108-447.720454-138.377206 0 0-19.553301-172.470141-27.073801-339.425248-6.517767-143.390873-1.002733-282.770813 0.501366-305.833681C174.475608-6.308547 61.166736 47.337689 0 69.89919c0 0 73.199537 309.844614 126.344406 952.59671 0 0 84.730971 9.0246 230.12731-19.051934s317.365114-115.815705 302.825481-219.097244m-341.932083 140.88404l-24.566967-176.982441c6.0164-3.0082 156.927774 53.144869 172.971507 63.172203-2.506833 11.030067-148.40454 113.810238-148.40454 113.810238" p-id="2978" fill="#cdcdcd"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/notes/230501-ekf/">
                <img src="/notes/230501-ekf/cover_hu26ae92dd6b118305d9748826b5136196_1172678_800x0_resize_q75_box.jpg"
                        srcset="/notes/230501-ekf/cover_hu26ae92dd6b118305d9748826b5136196_1172678_800x0_resize_q75_box.jpg 800w, /notes/230501-ekf/cover_hu26ae92dd6b118305d9748826b5136196_1172678_1600x0_resize_q75_box.jpg 1600w"
                        width="800" 
                        height="450" 
                        loading="lazy"
                        alt="Featured image of post Extended Kalman Filter" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/notes/" style="background-color: #6495ED; color: #fff;">
                Notes
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/notes/230501-ekf/">Extended Kalman Filter</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Step by step derivation of the Kalman Filter, and introduce the EKF.
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 01, 2023</time>
            </div>
        

        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><code>WIP</code></p>
<p>This post summarizes my understanding of the Extended Kalman Filter (EKF). I once used EKF to filter noisy barometer data in my antenna tracking system. At that time I wrote in the repository:</p>
<blockquote>
<p>I don&rsquo;t quite understand how a kalman filter works (just for now), so the code for this part is written by Similar_Fair. Click the link below for more information: <a class="link" href="https://blog.csdn.net/sunhaobo1996/article/details/53861752"  target="_blank" rel="noopener"
    >https://blog.csdn.net/sunhaobo1996/article/details/53861752</a>.</p>
</blockquote>
<p>And that was on Sep 9, 2018. Four years later, I had to use EKF in my adaptive controller project and finally had it figured out.</p>
<h2 id="linear-kalman-filter">Linear Kalman Filter</h2>
<p>The Kalman Filter is also called the optimal linear estimator or filter, as it aims to minimize the sum of autocovariance of variables. While the original Kalman Filter works with linear systems, the EKF extends its working domain to non-linear systems by using Taylor expansion linearization. Understanding KF is the first step towards understanding the EKF. The <a class="link" href="https://www.bilibili.com/video/BV1ez4y1X7eR/"  target="_blank" rel="noopener"
    >videos</a> here are very helpful.</p>
<h3 id="problem-formulation">Problem Formulation</h3>
<p>Consider a discrete-time linear system:</p>
<p>$$
\begin{equation}
\begin{cases}
\bm{x}<em>k = \bm{G} \bm{x}</em>{k-1} + \bm{H} \bm{u}<em>{k-1} + \bm{w}</em>{k-1} \
\bm{z}_k = \bm{M} \bm{x}_k + \bm{v}_k
\end{cases}
\end{equation}
$$</p>
<p>where $\bm{x}$ is the state vector, $\bm{w}$ is the process noise that is assumed to satisfy normal distribution of $N(0, \bm{Q})$, $\bm{z}$ is the observation vector, and $\bm{v}$ is the measurement noise s.t. $N(0, \bm{R})$. The dynamics of the process noise and measurement noise are unknown, which is the reason for modeling them as stochastic variables.</p>
<p>With these two equations, the mean value of the state vector can be estimated in two ways:</p>
<p>$$
\begin{equation}
\begin{cases}
\hat{\bm{x}}<em>k^- = \bm{G} \bm{x}</em>{k-1} + \bm{H} \bm{u}_{k-1} \
\hat{\bm{x}}_k^+ = \bm{M}^{-1} \bm{z}_k
\end{cases}
\end{equation}
$$</p>
<p>one by propagating system states and inputs from the last time step, and one by inferring from the measured values. In most cases $\hat{\bm{x}}_k^- \neq \hat{\bm{x}}_k^+$, which means we need to combine, or &ldquo;fuse&rdquo;, these two estimations into one $\hat{\bm{x}}_k$. This step is often implemented using the weighted average. The weight $\rho_k$ may be different for different time steps:</p>
<p>$$
\begin{equation}
\begin{split}
\hat{\bm{x}}_k
&amp;= (1 - \rho_k) \hat{\bm{x}}_k^- + \rho_k \hat{\bm{x}}_k^+ \
&amp;= \hat{\bm{x}}_k^- + \rho_k (\hat{\bm{x}}_k^+ - \hat{\bm{x}}_k^-) \
&amp;= \hat{\bm{x}}_k^- + \rho_k (\bm{M}^{-1} \bm{z}_k - \hat{\bm{x}}_k^-) \
&amp;= \hat{\bm{x}}_k^- + \rho_k \bm{M}^{-1} (\bm{z}_k - \bm{M} \hat{\bm{x}}_k^-) \
&amp;= \hat{\bm{x}}_k^- + \bm{K}_k (\bm{z}_k - \bm{M} \hat{\bm{x}}_k^-)
\end{split}
\end{equation}
$$</p>
<p>where $\bm{K}_k = \rho_k \bm{M}^{-1}$ is often called the &ldquo;Kalman gain&rdquo;. Now, how to determine the value of $\bm{K}_k$? Please remember that we are looking at stochastic variables with variances: let&rsquo;s define a variable for estimation error as $\bm{e}_k = \bm{x}_k - \hat{\bm{x}}_k$, and $\bm{e}_k \sim N(0, \bm{P}_k)$. We ultimately want to find a $\bm{K}_k$ that makes $\text{trace}(\bm{P}_k)$ minimal, which means minimizing the sum of error autocovariance.</p>
<h3 id="error-covariance-calculation">Error Covariance Calculation</h3>
<p>By the definition of covariance, we can express $\bm{P}_k$ as:</p>
<p>$$
\begin{equation}
\begin{split}
\bm{P}_k
&amp;= \mathbb{E}[\bm{e}_k \bm{e}_k^\intercal] \
&amp;= \mathbb{E}[(\bm{x}_k - \hat{\bm{x}}_k) (\bm{x}_k - \hat{\bm{x}}_k^\intercal)]
\end{split}
\end{equation}
$$</p>
<p>Swap $\hat{\bm{x}}_k$ with the weighted average expression, and note $\bm{x}_k - \hat{\bm{x}}_k^-$ as $\bm{e}_k^-$, we have:</p>
<p>$$
\begin{equation}
\begin{split}
\bm{P}_k = \mathbb{E}[
&amp;(\mathbb{I}-\bm{K}_k\bm{M})\bm{e}_k^-((\mathbb{I}-\bm{K}_k\bm{M})\bm{e}_k^-)^\intercal\
&amp;- (\mathbb{I}-\bm{K}_k\bm{M})\bm{e}_k^-\bm{v}_k\bm{K}_k^\intercal\
&amp;- \bm{K}_k \bm{v}_k {\bm{e}_k^-}^\intercal(\mathbb{I}-\bm{K}_k\bm{M})^\intercal\
&amp;+ \bm{K}_k \bm{v}_k (\bm{K}_k \bm{v}_k)^\intercal]
\end{split}
\end{equation}
$$</p>
<p>Then calculate the expectation of each term:</p>
<p>$$
\begin{equation}
\begin{split}
\bm{P}_k &amp;= (\mathbb{I}-\bm{K}_k\bm{M}) \mathbb{E}[\bm{e}_k^- {\bm{e}_k^-}^\intercal] (\mathbb{I}-\bm{K}_k\bm{M})^\intercal\
&amp;- 0 \
&amp;- 0 \
&amp;+ \bm{K}_k\bm{R}{\bm{K}_k}^\intercal
\end{split}
\end{equation}
$$</p>
<p>Nice, the second and third terms are all expected to be zero since $\bm{e}$ and $\bm{v}$ are not correlated. Here we encounter $\mathbb{E}[\bm{e}_k^-{\bm{e}_k^-}^\intercal]$, let&rsquo;s call it $\bm{P}_k^-$. Then we can expand $\bm{P}_k$ to an even simpler form:</p>
<p>$$
\begin{equation}
\bm{P}_k = \bm{P}_k^- - \bm{K}_k\bm{M}\bm{P}_k^- - (\bm{K}_k\bm{M}\bm{P}_k^-)^\intercal + \bm{K}_k\bm{M}\bm{P}_k^-(\bm{K}_k\bm{M})^\intercal+\bm{K}_k\bm{R}\bm{K}_k^\intercal
\end{equation}
$$</p>
<h3 id="minimizing-the-trace">Minimizing the Trace</h3>
<p>From the last equation we have:</p>
<p>$$
\begin{equation}
\text{tr}(\bm{P}_k) = \text{tr}(\bm{P}_k^-) - 2\text{tr}(\bm{K}_k\bm{M}\bm{P}_k^-) + \text{tr}(\bm{K}_k\bm{M}\bm{P}_k^-(\bm{K}_k\bm{M})^\intercal) + \text{tr}(\bm{K}_k\bm{R}\bm{K}_k^\intercal)
\end{equation}
$$</p>
<p>which is a function of $\bm{K}_k$ with a minima at some point. Now, the problem is reduced to solving $\frac{d\text{tr}(\bm{P}_k)}{d\bm{K}_k} = 0$. There are two equations that greatly help the solving process:</p>
<p>$$
\begin{equation}
\frac{d\text{tr}(\bm{A}\bm{B})}{d\bm{A}} = \bm{B}^\intercal
\end{equation}
$$</p>
<p>$$
\begin{equation}
\frac{d\text{tr}(\bm{A}\bm{B}{\bm{A}}^\intercal)}{d\bm{A}} = 2\bm{A}\bm{B}
\end{equation}
$$</p>
<p>Expand $\frac{d\text{tr}(\bm{P}_k)}{d\bm{K}_k} = 0$:</p>
<p>$$
\begin{equation}
\begin{split}
\frac{d\text{tr}(\bm{P}_k)}{d\bm{K}_k} = 0 - 2(\bm{M}\bm{P}_k^-)^\intercal + 2\bm{K}_k\bm{M}\bm{P}_k^-\bm{M}^\intercal+2\bm{K}_k\bm{R} = 0
\end{split}
\end{equation}
$$</p>
<p>Solving the above equation gives the Kalman gain: $\bm{K}_k = \frac{\bm{P}_k^-\bm{M}^\intercal}{\bm{M}\bm{P}_k^-\bm{M}^\intercal+\bm{R}}$. Problem solved! Well, not really. The final step is to calculate $\bm{P}_k^-$. Since</p>
<p>$$
\begin{equation}
\bm{e}_k^-=\bm{x}<em>k - \hat{\bm{x}}<em>k^-=\bm{G}\bm{e}</em>{k-1}+\bm{w}</em>{k-1}
\end{equation}
$$</p>
<p>and $\bm{P}_k^-$ can be written in the expectation form, we have:</p>
<p>$$
\begin{equation}
\begin{split}
\bm{P}<em>k^-
&amp;= \mathbb{E}[\bm{G}\bm{e}</em>{k-1}(\bm{G}\bm{e}<em>{k-1})^\intercal] + \bm{G}\mathbb{E}[\bm{e}</em>{k-1}\bm{w}<em>{k-1}^\intercal]+\mathbb{E}[\bm{e}</em>{k-1}\bm{w}<em>{k-1}^\intercal]\bm{G}^\intercal+\mathbb{E}[\bm{w}</em>{k-1}\bm{w}<em>{k-1}^\intercal] \
&amp;=\bm{G}\bm{P}</em>{k-1}\bm{G}^\intercal+\bm{Q}
\end{split}
\end{equation}
$$</p>
<p>Now the derivation is complete - we&rsquo;ve found the optimal gain to fuse two estimations together to make covariance minimal. The complete update steps of the Kalman Filter are:</p>
<p>$$
\begin{equation}
\begin{split}
&amp;\text{1.}\ \hat{\bm{x}}<em>k^- = \bm{G} \bm{x}</em>{k-1} + \bm{H} \bm{u}_{k-1} \
&amp;\text{2.}\ \bm{P}<em>k^- = \bm{G}\bm{P}</em>{k-1}\bm{G}^\intercal+\bm{Q} \
&amp;\text{3.}\ \bm{K}_k = \frac{\bm{P}_k^-\bm{M}^\intercal}{\bm{M}\bm{P}_k^-\bm{M}^\intercal+\bm{R}} \
&amp;\text{4.}\ \hat{\bm{x}}_k=\hat{\bm{x}}_k^- + \bm{K}_k (\bm{z}_k - \bm{M} \hat{\bm{x}}_k^-) \
&amp;\text{5.}<br>
\begin{split}
\bm{P}_k &amp;= \bm{P}_k^- - \bm{K}_k\bm{M}\bm{P}_k^- - (\bm{K}_k\bm{M}\bm{P}_k^-)^\intercal + \bm{K}_k\bm{M}\bm{P}_k^-(\bm{K}_k\bm{M})^\intercal+\bm{K}_k\bm{R}\bm{K}_k^\intercal \
&amp;= \bm{P}_k^- - \bm{K}_k\bm{M}\bm{P}_k^-
\end{split}
\end{split}
\end{equation}
$$</p>
<h2 id="extended-kalman-filter">Extended Kalman Filter</h2>
<p>EKF extends the original flavored KF to nonlinear systems by using Taylor series expansion. That is it.</p>
<p>$$
\begin{equation}
\begin{split}
&amp;\begin{cases}
\bm{x}<em>k = f</em>{RK4}(\bm{x}<em>{k-1}, \bm{u}</em>{k-1}, \bm{w}<em>{k-1})\
\bm{z}<em>k = g(\bm{x}</em>{k},\bm{v}<em>k)
\end{cases} \
\rightarrow
&amp;\begin{cases}
\bm{x}<em>k = f</em>{RK4}(\hat{\bm{x}}</em>{k-1}, \bm{u}</em>{k-1}, \bm{0}) + \frac{\partial f_{RK4}(\hat{\bm{x}}<em>{k-1},\bm{u}</em>{k-1},\bm{0})}{\partial \bm{x}}(\bm{x}<em>{k-1}-\hat{\bm{x}}</em>{k-1}) + \frac{\partial f_{RK4}(\hat{\bm{x}}<em>{k-1},\bm{u}</em>{k-1},\bm{0})}{\partial \bm{w}}\bm{w}<em>{k-1}\
\bm{z}<em>k = g(\hat{\bm{x}}</em>{k},\bm{0})+\frac{\partial g(\hat{\bm{x}}</em>{k},\bm{0})}{\partial \bm{x}}(\bm{x}<em>{k}-\hat{\bm{x}}</em>{k})+\frac{\partial g(\hat{\bm{x}}<em>{k},\bm{0})}{\partial \bm{v}}\bm{v}</em>{k}
\end{cases} \
:=
&amp;\begin{cases}
\bm{x}_k = \hat{\bm{x}}<em>k^- + \bm{G}<em>k(\bm{x}</em>{k-1}-\hat{\bm{x}}</em>{k-1}) + \bm{W}<em>k\bm{w}</em>{k-1} \
\bm{z}_k = \hat{\bm{z}}<em>k + \bm{M}<em>k(\bm{x}</em>{k}-\hat{\bm{x}}</em>{k})+\bm{V}<em>k\bm{v}</em>{k-1}
\end{cases}
\end{split}
\end{equation}
$$</p>
<p>The linearized version is slightly different from the original linear form, but the derivation for the algorithm is largely the same. I won&rsquo;t type everything again here but only give the complete result below. Interested readers are suggested to work it out independently.</p>
<blockquote>
<p>Q. Quan, Introduction to multicopter design and control. Springer, 2017.</p>
</blockquote>
<p>$$
\begin{equation}
\begin{split}
&amp;\text{1.}\ \hat{\bm{x}}<em>k^- = f</em>{RK4}(\hat{\bm{x}}<em>{k-1}, \bm{u}</em>{k-1}, \bm{0}) \
&amp;\text{2.}\ \bm{P}<em>k^- = \bm{G}</em>{k-1}\bm{P}<em>{k-1}\bm{G}</em>{k-1}^\intercal+ \bm{W}<em>{k-1}\bm{Q}</em>{k-1}\bm{W}_{k-1}^\intercal \
&amp;\text{3.}\ \bm{K}_k = \frac{\bm{P}_k^-\bm{M}_k^\intercal}{\bm{M}_k\bm{P}_k^-\bm{M}_k^\intercal+\bm{V}_k\bm{R}\bm{V}_k^\intercal} \
&amp;\text{4.}\ \hat{\bm{x}}_k=\hat{\bm{x}}_k^- + \bm{K}_k (\bm{z}_k - \hat{\bm{z}}_k) \
&amp;\text{5.}\ \bm{P}_k = \bm{P}_k^- - \bm{K}_k\bm{M}_k\bm{P}_k^-
\end{split}
\end{equation}
$$</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/gre/">GRE</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/notes/211212-gre/">
        
        
            <div class="article-image">
                <img src="/notes/211212-gre/cover.513c577b711a9da482fe521dfcaffcdd_hu77614c637fc6c9a84dc47c4d43e7b525_303754_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post さよなら〜GRE"
                        
                        data-hash="md5-UTxXe3EanaSC/lId/K/83Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">さよなら〜GRE</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/notes/211229-mobilerobot/">
        
        
            <div class="article-image">
                <img src="/notes/211229-mobilerobot/cover.10cc165c9abef626461a941961f16dbf_hu51328586977ed3b7b80ac2bd02aacb27_216134_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Notes for Introduction to Autonomous Mobile Robots"
                        
                        data-hash="md5-EMwWXJq&#43;9iZGGpQZYfFtvw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Notes for Introduction to Autonomous Mobile Robots</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2021 - 
        
        2023 Ryan&#39;s Page
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
